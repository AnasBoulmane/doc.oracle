<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Dynamo/Client/Store/web/store.war/shared/js/pageLayout/user.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: Dynamo/Client/Store/web/store.war/shared/js/pageLayout/user.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/**
 * @fileoverview Defines a UserViewModel used to register and
 * login a user to the site.
 *
 */

/*global $ */
/*global define */
define(
  //-------------------------------------------------------------------
  // PACKAGE NAME
  //-------------------------------------------------------------------
  'pageLayout/user',
  
  //-------------------------------------------------------------------
  // DEPENDENCIES
  //-------------------------------------------------------------------
  ['knockout', 'pubsub', 'notifier', 'notifications', 'CCi18n', 'ccLogger',
   'ccRestClient', 'ccConstants', 'koValidate', 'ccKoValidateRules',
   'storeKoExtensions', 'navigation', 'storageApi', 'pageLayout/parent-organisation'],
    
  //-------------------------------------------------------------------
  // MODULE DEFINITION
  //-------------------------------------------------------------------
  function (ko, pubSub, notifier, notifications, CCi18n, log, ccRestClient, 
            CCConstants, koValidate, rules, storeKoExtensions, navigation, storageApi, ParentOrganisation) {
  
    'use strict';
    
    /** 
     * Creates a user view model.
     * &lt;p>
     * The User View Model is a singleton class that provides the context for logged in
     * user data, e.g. Profile data, Preferences, Shipping information.
     * 
     * @param {RestAdapter} pAdapter REST adapter.
     * @param {Object} pUserData Additional user data.
     * 
     * @public
     * @class Represents a user.
     * @name UserViewModel
     * @property {observable&lt;string>} firstName First part of name
     * @property {observable&lt;string>} lastName Last part of name
     * @property {observable&lt;string>} loggedInUserName Logged in username.
     * @property {observable&lt;string>} emailAddress Primary communication email address.
     * @property {observable&lt;string>} emailAddressForForgottenPwd Email address to use for password retrieval.
     * @property {observable&lt;string>} emailMarketingMails Email address to use for marketing messages.
     * @property {observable&lt;boolean>} emailMarketingModified Flag showing if the marketing email field is modified.
     * @property {observable&lt;string>} password Password.
     * @property {observable&lt;string>} oldPassword Existing password field on change password form.
     * @property {observable&lt;string>} newPassword New password field on change password form.
     * @property {observable&lt;string>} confirmPassword Confirm password field on change password form.
     * @property {observableArray&lt;Address>} shippingAddressBook Shipping addresses associated with user.
     * @property {observable&lt;Address>} defaultShippingAddress helper for default address selection.
     * @property {observable&lt;Address>} editShippingAddress Address object shown on editable address form.
     * @property {observable&lt;boolean>} deleteShippingAddress Flag set to true if an address is being deleted.
     * @property {observable&lt;string>} locale User locale.
     * @property {observable&lt;boolean>} loggedinAtCheckout Flag to determine if user is logged in on the checkout page.
     * @property {observable&lt;boolean>} loggedoutAtCheckout Flag to determine if user if logged out on the checkout page.
     * @property {observable&lt;Object>} persistedOrder Saved recent, or in progress order.
     * @property {observable&lt;string>} orderId ID of recent, or in progress order.
     * @property {observable&lt;number>} countOfSubmittedOrders Track number of orders created by user.
     * @property {observable&lt;boolean>} ignoreEmailValidation Flag to temporarily ignore validation on email address field.
     * @property {observable&lt;boolean>} ignorePasswordValidation Flag to temporarily ignore validation on password field.
     * @property {observable&lt;boolean>} isUserProfileEdited Whether the User profile has unsaved changes.
     * @property {observable&lt;boolean>} delaySuccessNotification Whether to delay the notification popup.
     * @property {observable&lt;boolean>} isSearchInitiatedWithUnsavedChanges Whether there are unsaved changes when a search is initiated.
     * @property {observable&lt;boolean>} isUserSessionExpired True if the user's session has expired.
     * @property {observable&lt;string>} pageToRedirect Hash code for page redirection
     * @property {observable&lt;boolean>} isSessionExpiredDuringSave True if the user's session expires when a save operation is in progress.
     * @property {observable&lt;boolean>} isUserLoggedOut True if user has logged out.
     * @property {observable&lt;boolean>} isPageRedirected True if page was redirected.
     * @property {observable&lt;boolean>} isResourcesLoaded True when resources are loaded.
     * @property {observable&lt;string>} errorMessageKey Resource key to look up current error notification message.
     * @property {observable&lt;string>} successMessageKey Resource key to look up current success notification message.
     * @property {observable&lt;Object[]>} passwordPolicies List of store specific password rules enabled for user accounts.
     * @property {observable&lt;boolean>} isChangePassword Flag to determine if we need to display the password change fields.
     * @property {observable&lt;boolean>} showCreateNewPasswordMsg Flag to determine whether to display the new password prompt.
     * @property {observable&lt;string>} createNewPasswordError Message to display if password creation failed.
     * @property {observable&lt;boolean>} isPasswordExpired True if password has expired.
     * @property {observable&lt;boolean>} hasFieldLevelError True if any of the fields on the profile has an error.
     * @property {observable&lt;boolean>} ignoreConfirmPasswordValidation Flag to temporarily ignore validation on the confirm password field.
     * @property {observable&lt;string>} forgotPasswordMsg Localisable message for 'forgotten password' link.
     * @property {observable&lt;Object[]>} myWishLists List of owned wish lists
     * @property {observable&lt;Object[]>} joinedWishLists List of joined wish lists
     */
    function UserViewModel(pAdapter, pUserData) {
      
      if (UserViewModel.singleInstance) {
        throw new Error("Cannot instantiate more than one UserViewModel, use getInstance(pAdapter, pUserData)");  
      }
      var self = this;
      
      // Adding user data from server to the view model
      // Currently ignoring the 'links' property as it is not being used and causing problems in ccLink custom binding
      ko.mapping.fromJS(pUserData, {'ignore': ["links"]}, self);
      
      // Values from context
      self.id = ko.observable('');
      self.login = ko.observable('');
      self.adapter = pAdapter;
      
      // Flags
      self.resetAll = ko.observable(false);
      
      // Values to be entered
      self.emailAddress = ko.observable('');
      self.emailAddressForForgottenPwd = ko.observable('');
      self.emailMarketingMails = ko.observable(false);
      self.emailMarketingModified = ko.observable(false);
      self.firstName = ko.observable('');
      self.loggedInUserName = ko.observable('');
      self.lastName = ko.observable('');
      self.password = ko.observable('');
      self.newPassword = ko.observable('');
      self.confirmPassword = ko.observable('');
      self.shippingAddressBook = ko.observableArray().extend({ deferred: true });
      self.defaultShippingAddress = ko.observable(); // For default address radio selection.
      self.editShippingAddress = ko.observable(); // Used when the edit address form is displayed.
      self.deleteShippingAddress = ko.observable(false);
      self.locale = ko.observable('');
      
      self.client = ko.observable(ccRestClient);
      self.loginError = ko.observable('');
      self.loggedIn = ko.observable(self.client().loggedIn);
      self.isLoginFailed = ko.observable(false);
      self.readyToDisplay = ko.observable(true);
      
      self.oldPassword = ko.observable('');
      
      self.emailAddress.isData = true;
      self.firstName.isData = true;
      self.lastName.isData = true;
      self.password.isData = true;
      self.newPassword.isData = true;
      self.confirmPassword.isData = true;  
      self.oldPassword.isData = true;
      self.emailAddressForForgottenPwd.isData = true;
      self.locale.isData = true;
      
      self.loggedinAtCheckout = ko.observable(false);
      self.loggedoutAtCheckout = ko.observable(false);
      self.persistedOrder =  ko.observable();
      self.orderId = ko.observable('');
      self.countOfSubmittedOrders = ko.observable(0);
      
      self.ignoreEmailValidation = ko.observable(true);
      self.ignorePasswordValidation = ko.observable(true);
      self.isUserProfileEdited = ko.observable(false);
      self.delaySuccessNotification = ko.observable(false);
      self.isSearchInitiatedWithUnsavedChanges = ko.observable(false);
      
      self.isUserSessionExpired = ko.observable(false);
      self.pageToRedirect = ko.observable();
      self.isSessionExpiredDuringSave = ko.observable(false);
      self.isUserLoggedOut = ko.observable(true);
      self.isPageRedirected = ko.observable(false);
      self.isResourcesLoaded = ko.observable(false);
      
      self.errorMessageKey = ko.observable('');
      self.successMessageKey = ko.observable('');
      
      // Sets the password policies
      self.passwordPolicies = ko.observable();
      // Checks whether the case is a change password
      self.isChangePassword = ko.observable(false);
      
      self.showCreateNewPasswordMsg = ko.observable(false);
      self.createNewPasswordError = ko.observable('');
      self.isPasswordExpired = ko.observable(false);
      self.hasFieldLevelError = ko.observable(false);
      self.ignoreConfirmPasswordValidation = ko.observable(true);
      self.forgotPasswordMsg = ko.observable('');
      
      // Social Wish List
      self.myWishLists = ko.observableArray();
      self.joinedWishLists = ko.observableArray();
      
      self.isSesExpDuringPlaceOrder = ko.observable(false);

      // B2B ViewModel
      self.parentOrganization = new ParentOrganisation();
      self.refreshPageAfterContactLogout = ko.observable(false);
      self.catalogId = ko.observable('');

      /**
       * Callback invoked when email address field receives focus. Disables email validation.
       * 
       * @function 
       * @name UserViewModel#emailAddressFocused
       */
      self.emailAddressFocused = function() {
        self.ignoreEmailValidation(true);
        return true;
      };

      /**
       * Callback invoked when email address field loses focus. Re-enable email validation.
       * 
       * @function
       * @name UserViewModel#emailAddressLostFocus
       */
      self.emailAddressLostFocus = function() {
        self.ignoreEmailValidation(false);
        return true;
      };

      self.updatedShippingAddress = null;
      self.updatedShippingAddressBook = null;
      
      /*
       * Callback invoked when confirm password field is modified.
       */
      self.confirmPassword.subscribe(function(newValue) {
        self.newPassword.isModified(true);
      });
      
      /*
       * Callback invoked when marketing emails field is modified.
       */
      self.emailMarketingMails.subscribe(function(newValue) {
        self.emailMarketingModified(true);
      });
      
      /**
       * Callback to update shipping address if modified from other parts of the site. Invoked on
       * receiving a CHECKOUT_SAVE_SHIPPING_ADDRESS pubsub event.
       * 
       * @private
       * @function
       * @name UserViewModel#updateShippingAddress
       */
      self.updateShippingAddress = function(opts) {
        // Now if any other module is updating a shipping address on the User Profile, it will just be
        // adding a secondary address.
        if (self.shippingAddressBook()) {
          this.isDefaultAddress(self.shippingAddressBook().length === 0);

          if (!self.isAddressSaved(this) &amp;&amp; this.isValid()) {
            self.shippingAddressBook.push(this);
          }        
        }
      };
      
      /**
       * Updates the locale associated to this user. Invoked on receiving
       * a CHECKOUT_USER_LOCALE pubsub event.
       * 
       * @private
       * @function
       * @name UserViewModel#updateLocale
       */
      self.updateLocale = function() {
        self.locale(this);
      };
      
      /**
       * Updates the user locale when it is not part of supported locales. Invoked on receiving
       * a USER_LOCALE_NOT_SUPPORTED pubsub event.
       * 
       * @private
       * @function
       * @name UserViewModel#updateLocaleToSupported
       */
      self.updateLocaleToSupported = function() {
        if (self.locale.isModified !== undefined) {
          var currentLocale = ccRestClient.getStoredValue(CCConstants.LOCAL_STORAGE_USER_CONTENT_LOCALE);
          if (currentLocale) {
            self.locale(JSON.parse(currentLocale)[0].name);
          } else {
        	  self.locale(self.contextData.global.locale);
          }
            self.locale.isModified(true);
            $.Topic(pubSub.topicNames.USER_PROFILE_UPDATE_SUBMIT).publishWith(self, [{message: "success"}]);
            self.locale.isModified(false);
            $.Topic(pubSub.topicNames.UPDATE_USER_LOCALE_NOT_SUPPORTED_ERROR).publish();
          
        }
      };
      
      /* 
       * This computed will return  whether the error message on the 
       * create new password modal should be visible or not.
       */
      self.showExpiredPasswordErrorMsg = ko.computed(function() {
        if (self.isPasswordExpired() &amp;&amp; 
             ((self.oldPassword.isModified() &amp;&amp; !self.oldPassword.isValid()) ||
              (self.newPassword.isModified() &amp;&amp; !self.newPassword.isValid()) ||
              (self.confirmPassword.isModified() &amp;&amp; !self.confirmPassword.isValid()) ||
              self.hasFieldLevelError())) {
          return false;
        }
        return true;
      }, self);
      
      /**
       * Handle the validation of the user data entered while creating an account.
       * 
       * @function
       * @name UserViewModel#validateUser
       * @returns {boolean} &lt;code>true&lt;/code> if the user details are valid, and
       * &lt;code>false&lt;/code> otherwise.
       */
      self.validateUser = function() {
        self.ignoreEmailValidation(false);
        self.ignorePasswordValidation(false);
        self.ignoreConfirmPasswordValidation(false);
        self.emailAddress.isModified(true);
        self.firstName.isModified(true);
        self.lastName.isModified(true);
        self.newPassword.isModified(true);
        self.confirmPassword.isModified(true);
        return self.isValid();
      };
      
      /**
       * Check if the complete user profile is valid by checking the components.
       * 
       * @function
       * @name UserViewModel#isValid
       * @returns {boolean} true if the user profile is valid, otherwise false.
       */
      self.isValid = function() {
        return (self.emailAddress.isValid() &amp;&amp;
                self.firstName.isValid() &amp;&amp; 
                self.lastName.isValid() &amp;&amp; 
                self.newPassword.isValid() &amp;&amp; 
                self.confirmPassword.isValid()
        );
      };
      
      /**
       * Reset all registration details.
       * 
       * @function
       * @name UserViewModel#reset
       */
      self.reset = function() {
        if (self.isUserLoggedOut() || (!self.loggedIn() &amp;&amp; !self.isUserSessionExpired())) {
          self.login('');
          if (self.isResourcesLoaded()) {
            self.login.isModified(false);
          }
          self.loggedInUserName('');
        }
        self.emailAddress('');
        self.firstName('');
        self.lastName('');
        self.loginError('');
        self.resetPassword();
        self.isLoginFailed(false);
        self.emailMarketingMails(false);
        if (self.isResourcesLoaded()) {
          self.lastName.isModified(false);
          self.emailAddress.isModified(false);
          self.firstName.isModified(false);
        }
      };
      
      /**
       * Reset the password field.
       * 
       * @function
       * @name UserViewModel#resetPassword
       */
      self.resetPassword = function() {
        self.password('');
        self.newPassword('');
        self.confirmPassword('');
        self.oldPassword('');
        if (self.isResourcesLoaded()) {
          self.password.isModified(false);
          self.newPassword.isModified(false);
          self.confirmPassword.isModified(false);
          self.oldPassword.isModified(false);
        }
        self.isChangePassword(false);
      };
      
      /**
       * Reset all the details from the registration fields without
       * resetting the email address.
       * 
       * @function
       * @name UserViewModel#resetDetails
       */
      self.resetDetails = function() {
        self.firstName('');
        self.lastName('');
        self.resetPassword();
        self.emailMarketingMails(false);
        self.firstName.isModified(false);
        self.lastName.isModified(false);
        self.emailMarketingModified(false);
      };
      
      /**
       * Handle the validation of login.
       * 
       * @function
       * @name UserViewModel#isLoginValid
       * @returns {boolean} true if login is valid, otherwise false. 
       */
      self.isLoginValid = function() {
        self.ignoreEmailValidation(false);
        return (this.login.isValid()
            &amp;&amp; this.password.isValid());
      };
      
      /**
       * Handle the validation of user data entered during login. Also raises the modified flags on
       * login and password fields.
       * 
       * @function
       * @name UserViewModel#validateLogin
       * @returns {boolean} true if login is valid, otherwise false.
       */
      self.validateLogin = function() {
        var self = this;
        self.login.isModified(true);
        self.password.isModified(true);
        return self.isLoginValid();
      };   	  
      
      /**
       * Reset login details.
       * 
       * @function
       * @name UserViewModel#resetLoginData 
       */
      self.resetLoginData =  function() {
        var self = this;
        self.login('');
        self.password('');
        self.loginError('');
        self.isLoginFailed(false);
        if (self.isResourcesLoaded()) {
          self.login.isModified(false);
          self.password.isModified(false);
        }
      };
    
      /**
       * Reset modified flags on knockout observables.
       * 
       * @function
       * @name UserViewModel#resetModified
       */
      self.resetModified = function() {
        var self = this;
        self.emailAddress.isModified(false);
        self.firstName.isModified(false);
        self.lastName.isModified(false);
        self.oldPassword.isModified(false);
        self.newPassword.isModified(false);
        self.confirmPassword.isModified(false);
        self.emailMarketingModified(false);
      };
      
      /**
       * Reset modified flags of address objects in the address book.
       * 
       * @function
       * @name UserViewModel#resetShippingAddressBookModified
       */
      self.resetShippingAddressBookModified = function() {
        var self = this;
        ko.utils.arrayForEach(self.shippingAddressBook(), function (shippingAddress) {
          shippingAddress.resetModified();
        });
      };
      
      /**
       * Check whether profile is modified.
       * 
       * @function
       * @name UserViewModel#isProfileModified
       * @returns {boolean} true if profile has been modified, otherwise false.
       */
      self.isProfileModified = function() {
        // Checking whether user basic profile has been modified.
        if (self.firstName.isModified() || self.lastName.isModified() ||
            self.emailAddress.isModified() || self.emailMarketingModified() || self.locale.isModified()) {
          return true;
        }
        return false;
      };
      
      /**
       * Check whether any of the password fields have been
       * modified: oldPassword, newPassword, confirmPassword.
       * 
       * @function
       * @name UserViewModel#isPasswordModified
       * @returns {boolean} true if any password fields are modified, otherwise false.
       */
      self.isPasswordModified = function() {
          if (self.oldPassword.isModified() || self.newPassword.isModified() || self.confirmPassword.isModified()) {
            return true;
          }
          return false;
      };
      
      /**
       * Check whether all password fields are valid.
       * 
       * @function
       * @name UserViewModel#isPasswordValid
       * @returns {boolean} true if all password fields are valid, otherwise false.
       */
      self.isPasswordValid = function () {
        self.oldPassword.isModified(true);
        self.newPassword.isModified(true);
        self.confirmPassword.isModified(true);
        
        // Checking whether user password fields are valid.
        if (self.oldPassword.isValid() &amp;&amp; self.newPassword.isValid() &amp;&amp;
            self.confirmPassword.isValid()) {
          return true;
        }
        return false;
      };
      
      /**
       * Check whether profile is valid.
       * 
       * @function
       * @name UserViewModel#isProfileValid
       * @returns {boolean} true if the profile is valid, otherwise false.
       */
      self.isProfileValid = function () {
        self.firstName.isModified(true);
        self.lastName.isModified(true);
        self.emailAddress.isModified(true);
        self.ignoreEmailValidation(false);
        // Checking whether user basic profile has been modified.
        if (self.firstName.isValid() &amp;&amp; self.lastName.isValid() &amp;&amp;
            self.emailAddress.isValid()) {
          return true;
        }
        return false;
      };
      
      /**
       * Checks if the supplied address already exists in the profile address book.
       * 
       * @function
       * @name UserViewModel#isAddressSaved
       * @param {Address} addr An address object.
       * @returns {boolean} true if the address is already present, otherwise false.
       */
      self.isAddressSaved = function (addr) {
        
        for (var k = 0; k &lt; self.shippingAddressBook().length; k++) {
          if (addr.compare(self.shippingAddressBook()[k]))
          {
            return true;
          }
        }
        
        return false;
      };

      /**
       * Returns true if current user is b2b user.
       */
      self.isB2BUser = function(){
        if(self.parentOrganization &amp;&amp; self.parentOrganization.name()) {
          return true;
        }
        return false;
      }

      /**
       * Check if the shipping address book contains any addresses which have been modified.
       * 
       * @function
       * @name UserViewModel#isShippingAddressBookModified
       * @returns true if any shipping addresses are modified, otherwise false.
       */
      self.isShippingAddressBookModified = function() {
        if (self.deleteShippingAddress())
        {
          return true;
        }
        
        for (var k = 0; k &lt; self.shippingAddressBook().length; k++) {
          if (self.shippingAddressBook()[k].isModified())
          {
            return true;
          }
        }
        return false;
      };
      
      /**
       * Check if all the addresses in the shipping address book are valid.
       * 
       * @function
       * @name UserViewModel#isShippingAddressBookValid
       * @returns true if all shipping addresses are valid, otherwise false.
       */
      self.isShippingAddressBookValid = function() {
        for (var k = 0; k &lt; self.shippingAddressBook().length; k++) {
          if (!self.shippingAddressBook()[k].isValid())
          {
            return false;
          }
        }
        return true;
      };

      /**
       * Select a default shipping address from the shipping address book.
       * Assumes that addr is a reference to an Address object that already exists in the address book.
       * 
       * @function
       * @name UserViewModel#selectDefaultAddress
       * @param {Address} addr An address object.
       */
      self.selectDefaultAddress = function(addr) {
        for (var k = 0; k &lt; self.shippingAddressBook().length; k++) {
          var shippingAddress = self.shippingAddressBook()[k];
          shippingAddress.isDefaultAddress(shippingAddress === addr);
        }
      };

      /**
       * Sort the addresses in shipping address book by the following requirements:
       * 
       * &lt;ol>
       *   &lt;li>Default Shipping Address should always be first.&lt;/li>
       *   &lt;li>Then sort addresses by Last Name in ascending order.&lt;/li>
       *   &lt;li>Then sort addresses by Address Line 1 in ascending order.&lt;/li>
       * &lt;/ol>
       * 
       * @private
       * @function
       * @name UserViewModel#sortShippingAddresses
       */
      self.sortShippingAddresses = function () {
        if (self.updatedShippingAddressBook &amp;&amp; self.updatedShippingAddressBook.length) {
          self.updatedShippingAddressBook.sort(function(left, right) {
              // Default Address has the highest sort priority.
              if (left.isDefaultAddress)
                  return -1;
              if (right.isDefaultAddress)
                  return 1;

              if (left.lastName.toLowerCase() == right.lastName.toLowerCase()) {
                  return left.address1.toLowerCase() == right.address1.toLowerCase() ? 0 
                            : (left.address1.toLowerCase() &lt; right.address1.toLowerCase() ? -1 : 1);
              } else if (left.lastName.toLowerCase() &lt; right.lastName.toLowerCase()) {
                  return -1;
              } else {
                  return 1;
              }
          });
        }
      };
      
      /**
       * Successful Login Callback invoked on receiving a success response from the login service.
       * 
       * @private
       * @function
       * @name UserViewModel#loginSuccessFunc
       * @param {boolean} isAutoLogin Flag to track if user was logged in automatically, or 
       *        if we need to reset user data.
       */
      self.loginSuccessFunc = function(isAutoLogin) {
        self.loggedIn(self.client().loggedIn);
        self.isUserSessionExpired(false);
        self.isLoginFailed(false);
        self.isSesExpDuringPlaceOrder(false);
        self.isUserLoggedOut(false);
        self.password('');
        self.password.isModified(false);
        notifier.clearError(self.WIDGET_ID);
        self.id(self.client().profileId);
        if (self.pageToRedirect() &amp;&amp; self.pageToRedirect()!= '' &amp;&amp; self.pageToRedirect() != self.checkoutHash) {
          var hash = self.pageToRedirect();
          self.pageToRedirect(null);
          if (navigation.isPathEqualTo(hash)) {
            var localData = self.getLocalData();
            //if the session expired during the save on my profile page and if the user logs in with the same user, then do not reload the user data
            if (localData.login == self.login() &amp;&amp; navigation.isPathEqualTo(self.myAccountHash)  &amp;&amp; !self.isPasswordExpired() &amp;&amp; self.isSessionExpiredDuringSave()) {
              //self.isSessionExpiredDuringSave(false); this is set to false on the profile page
            } else {
              self.getCurrentUser(isAutoLogin, true);
              //if the session expired during the save on my profile page and if the user logs in with different login, then reset the user data
              if (navigation.isPathEqualTo(self.myAccountHash)) {
                self.isSessionExpiredDuringSave(false);
                $.Topic(pubSub.topicNames.USER_PROFILE_SESSION_RESET).publish();
              }
            }
          }
          self.isPageRedirected(true);
          navigation.goTo(hash);
        } else {
          self.getCurrentUser(isAutoLogin , true);
        }
        self.isPasswordExpired(false);
      };
      
      /**
       * Failed Login Callback invoked on receiving an error from the login service.
       * 
       * @private
       * @function
       * @name UserViewModel#loginErrorFunc
       */
      self.loginErrorFunc = function() {
        self.isLoginFailed(true);
        self.loginError(CCi18n.t('ns.common:resources.loginError'));
        self.password('');
        self.password.isModified(false);
      };
      
      self.populateUserFromLocalData(false);
      
      //section for calling the subscriptions 
      $.Topic(pubSub.topicNames.USER_REGISTRATION_SUBMIT).subscribe(self.registerUser);
      $.Topic(pubSub.topicNames.USER_LOGIN_SUBMIT).subscribe(self.handleLogin);
      $.Topic(pubSub.topicNames.USER_LOGIN_CANCEL).subscribe(self.handleCancel);
      // Custom extensions for registration fields
      // Wait until i18n is ready before attempting to resolve any resource bundles
      // This isn't strictly required because locale *should* be ready before
      // any view models are created, but just to be safe, subscribe anyway
      $.Topic(pubSub.topicNames.LOCALE_READY).subscribe(self.loadResources.bind(self));
      $.Topic(pubSub.topicNames.USER_PROFILE_UPDATE_SUBMIT).subscribe(self.handleUpdateProfile);
      $.Topic(pubSub.topicNames.USER_PROFILE_UPDATE_CANCEL).subscribe(self.handleUpdateCancel);
      $.Topic(pubSub.topicNames.PAGE_LAYOUT_LOADED).subscribe(self.handlePageChanged.bind(self));
      $.Topic(pubSub.topicNames.PAGE_METADATA_CHANGED).subscribe(self.handlePageChanged.bind(self));
      $.Topic(pubSub.topicNames.USER_LOGOUT_SUBMIT).subscribe(self.handleLogout.bind(self));
      $.Topic(pubSub.topicNames.USER_SESSION_VALID).subscribe(self.handleSessionValid.bind(self));
      $.Topic(pubSub.topicNames.USER_SESSION_EXPIRED).subscribe(self.handleSessionExpired.bind(self));
      $.Topic(pubSub.topicNames.CHECKOUT_SAVE_SHIPPING_ADDRESS).subscribe(self.updateShippingAddress);
      $.Topic(pubSub.topicNames.CHECKOUT_USER_LOCALE).subscribe(self.updateLocale);
      $.Topic(pubSub.topicNames.USER_LOCALE_NOT_SUPPORTED).subscribe(self.updateLocaleToSupported);
      
      return (self);
    };
    
    /**
     * Intialize localized validations and error messages. Invoked on receiving a .LOCALE_READY pubsub event.
     * 
     * @private
     * @function
     * @name UserViewModel#loadResources
     */
    UserViewModel.prototype.loadResources = function() {
      var self = this;
      self.firstName.extend({ required: { params: true, message: CCi18n.t('ns.common:resources.firstNameRequired')}});
      self.lastName.extend({ required: { params: true, message: CCi18n.t('ns.common:resources.lastNameRequired')}});
      self.locale.extend({ required: { params: true, message: CCi18n.t('ns.common:resources.localeRequired')}});
      self.emailAddressForForgottenPwd.extend({ 
        required: { params: true, message: CCi18n.t('ns.common:resources.emailAddressRequired')},
        maxLength: { params: CCConstants.CYBERSOURCE_EMAIL_MAXIMUM_LENGTH, message: CCi18n.t('ns.common:resources.maxLengthEmailAdd', {maxLength: CCConstants.CYBERSOURCE_EMAIL_MAXIMUM_LENGTH})},
        email: { params: true, onlyIf: function () { return (!self.ignoreEmailValidation()); }, message: CCi18n.t('ns.common:resources.emailAddressInvalid')}
      });
      self.emailAddress.extend({ 
        required: { params: true, message: CCi18n.t('ns.common:resources.emailAddressRequired')},
        maxLength: { params: CCConstants.CYBERSOURCE_EMAIL_MAXIMUM_LENGTH, message: CCi18n.t('ns.common:resources.maxLengthEmailAdd', {maxLength: CCConstants.CYBERSOURCE_EMAIL_MAXIMUM_LENGTH})},
        email:{ params: true, onlyIf: function () { return (!self.ignoreEmailValidation()); }, message: CCi18n.t('ns.common:resources.emailAddressInvalid')}});
      self.login.extend({ 
        required: { params: true, message: CCi18n.t('ns.common:resources.emailAddressRequired')},
        maxLength: { params: CCConstants.CYBERSOURCE_EMAIL_MAXIMUM_LENGTH, message: CCi18n.t('ns.common:resources.maxLengthEmailAdd', {maxLength: CCConstants.CYBERSOURCE_EMAIL_MAXIMUM_LENGTH})},
        email: { params: true, onlyIf: function () { return (!self.ignoreEmailValidation()); }, message: CCi18n.t('ns.common:resources.emailAddressInvalid')}});
      self.password.extend({ required: { params: true, message: CCi18n.t('ns.common:resources.passwordRequired')}});
      self.newPassword.extend({
        password: { params: { policies: self.passwordPolicies, login: self.emailAddress, observable: self.newPassword, includePreviousNPasswordRule: self.isChangePassword}, 
                    onlyIf: function () { return ( (!self.ignoreEmailValidation() || self.newPassword.isModified()) &amp;&amp; !self.ignorePasswordValidation() ); }, 
                    message: CCi18n.t('ns.common:resources.passwordPoliciesErrorText')},
        required: { params: true, message: CCi18n.t('ns.common:resources.passwordRequired')}
      });
      self.oldPassword.extend({ required: { params: true, message: CCi18n.t('ns.common:resources.currentPasswordRequired')}});
      self.confirmPassword.extend({ 
        required: { params: true, message: CCi18n.t('ns.common:resources.confirmPasswordRequired')},
        match: { params: self.newPassword, onlyIf: function () { return (!self.ignoreConfirmPasswordValidation()); }, message: CCi18n.t('ns.common:resources.passwordUnmatched')}});
      self.isResourcesLoaded(true);
    };
    
    /**
     * Read and populate the view model with loggedinAtCheckout, loggedoutAtCheckout, 
     * OrderID, loggedInUserName, login and isUserSessionExpired flags.
     * 
     * @function
     * @name UserViewModel#populateUserFromLocalData
     * @param {boolean} loadAll Flag to control whether we load all data.
     */    
    UserViewModel.prototype.populateUserFromLocalData = function (loadAll) {
      var self = this;
      //load the data from local storage
      var cookieData = self.getLocalData();
      if (cookieData != null) {
        self.loggedinAtCheckout(cookieData.loggedinAtCheckout);
        self.loggedoutAtCheckout(cookieData.loggedoutAtCheckout);
        self.orderId(cookieData.orderId);
        if (loadAll &amp;&amp; cookieData.login) {
          self.loggedInUserName(cookieData.loggedInUserName);
          self.login(cookieData.login);
          self.isUserSessionExpired(cookieData.isUserSessionExpired);
          self.isUserLoggedOut(cookieData.isUserLoggedOut);
        }
      }
    };
    
    /**
     * Read loggedinAtCheckout, loggedoutAtCheckout, OrderID, loggedInUserName, login 
     * and isUserSessionExpired flags from the user local storage.
     * 
     * @private
     * @function 
     * @name UserViewModel#getLocalData
     * @returns {Object} cookieData Parsed local storage data.
     */ 
    UserViewModel.prototype.getLocalData = function () {
      var self = this;
      //load the data from local storage
      var cookieData = null;
      try {
        cookieData = storageApi.getInstance().getItem("user");
        if (cookieData) {
          cookieData = JSON.parse(cookieData);
        }
      }
      catch (pError) {
      }
      return cookieData;
    };
    
    /**
     * Write the loggedinAtCheckout, loggedoutAtCheckout, OrderID, loggedInUserName, login and 
     * isUserSessionExpired flags to user local storage. The argument 'setParam' is a string which
     * may be one of the following:
     * 
     * &lt;ul>
     *  &lt;li>&lt;b>all&lt;/b> - Save all parameters.&lt;/li>
     *  &lt;li>&lt;b>checkoutFlag&lt;/b> - Save loggedInAtCheckout and loggedOutAtCheckout.&lt;/li>
     *  &lt;li>&lt;b>orderId&lt;/b> - Save orderID.&lt;/li>
     *  &lt;li>&lt;b>sessionExpiry&lt;/b> - Save isUserSessionExpired and isUserLoggedOut.&lt;/li>
     * &lt;/ul>
     * 
     * @private
     * @function
     * @name  UserViewModel#setLocalData
     * @param {string} setParam Enumerated string to select parameters saved to local storage.
     * @returns {boolean} true if setParam is falsey or empty, otherwise implicit return.
     */
    UserViewModel.prototype.setLocalData = function (setParam) {
      var self = this;
      if (!setParam &amp;&amp; setParam == '') {
        return true;
      }
      var userCookieData = self.getLocalData();
      if (userCookieData == null) {
        userCookieData = {};
      }
      switch (setParam) {
        case 'all':
          userCookieData = {
            loggedinAtCheckout: self.loggedinAtCheckout(),
            loggedoutAtCheckout: self.loggedoutAtCheckout(),
            orderId: self.orderId(),
            loggedInUserName: self.loggedInUserName(),
            login: self.login(),
            isUserSessionExpired: self.isUserSessionExpired(),
            isUserLoggedOut: self.isUserLoggedOut()
          };
          break;
        case 'checkoutFlag':
          userCookieData.loggedinAtCheckout = self.loggedinAtCheckout();
          userCookieData.loggedoutAtCheckout = self.loggedoutAtCheckout();
          break;
        case 'orderId':
          userCookieData.orderId = self.orderId();
          break;
        case 'sessionExpiry':
          userCookieData.isUserSessionExpired = self.isUserSessionExpired();
          userCookieData.isUserLoggedOut = self.isUserLoggedOut();
          break;
      }
      // Write the user to local storage
      try {
        storageApi.getInstance().setItem("user", JSON.stringify(userCookieData));
      }
      catch(pError) {
      }
    };
    
    /**
     * Update the values of loggedinAtCheckout, and loggedoutAtCheckout and write them to 
     * user local storage.
     * 
     * @function
     * @name UserViewModel#updateLocalData
     * @param {boolean} loggedinAtCheckout Whether the user is logged in on the checkout page.
     * @param {boolean} loggedoutAtCheckout Whether the user is logged out on the checkout page.
     */ 
    UserViewModel.prototype.updateLocalData = function(loggedinAtCheckout, loggedoutAtCheckout) {
      var self = this;
      self.loggedinAtCheckout(loggedinAtCheckout);
      self.loggedoutAtCheckout(loggedoutAtCheckout);
      self.setLocalData('checkoutFlag');
    };
    
    /**
     * Remove user local storage on logout.
     * 
     * @function
     * @name UserViewModel#removeLocalData
     */
    UserViewModel.prototype.removeLocalData = function() {
      try {
        storageApi.getInstance().removeItem("user");
      }
      catch(pError) {
      }
    };
    
    /**
     * Send a reset password email.
     * 
     * @function
     * @name #UserViewModel#resetForgotPassword 
     */ 
    UserViewModel.prototype.resetForgotPassword = function() {
      var self = this;
      var inputParams = {};
      
      inputParams[CCConstants.LOGIN] = self.emailAddressForForgottenPwd();
      
      self.adapter.persistCreate(CCConstants.ENDPOINT_FORGOT_PASSWORD, 'id', inputParams, null,
        //success callback 
        function(data) {
          $.Topic(pubSub.topicNames.USER_RESET_PASSWORD_SUCCESS).publish(data);
        },
        //error callback when an internal error occurs.
        function(data) {
          $.Topic(pubSub.topicNames.USER_RESET_PASSWORD_FAILURE).publish(data);
        }
      );
    };
    
    /**
     * Handle user login. Invoked on receiving a USER_LOGIN_SUBMIT pubsub event.
     * 
     * @private
     * @function
     * @name UserViewModel#handleLogin
     */
    UserViewModel.prototype.handleLogin = function() {
      var self = this;
      
      if (!self.isLoginValid()) {
        self.login.isModified(true);
        self.password.isModified(true);
        return false;
      }
      self.client().login(this.login(), this.password(),  
        // Success Function
        function() {
          self.loginSuccessFunc(false);
          $.Topic(pubSub.topicNames.USER_LOGIN_SUCCESSFUL).publish();
        },
        // Error function
        function(pResult) {
          if (pResult.error == CCConstants.PASSWORD_EXPIRED) {
            self.isPasswordExpired(true);
            $.Topic(pubSub.topicNames.USER_PASSWORD_EXPIRED).publish();
          } else if (pResult.error == CCConstants.PASSWORD_GENERATED) {
            self.isPasswordExpired(true);
            $.Topic(pubSub.topicNames.USER_PASSWORD_GENERATED).publish();
          } else {
            self.loginErrorFunc();
            $.Topic(pubSub.topicNames.USER_LOGIN_FAILURE).publish(pResult);
          }
        }
      );
    };
    
    /**
     * Handle user logout. Invoked on receiving a USER_LOGOUT_SUBMIT pubsub event.
     * 
     * @private
     * @function
     * @name UserViewModel#handleLogout
     */
    UserViewModel.prototype.handleLogout = function() {
      var self = this;
      $.Topic(pubSub.topicNames.USER_CLEAR_CART).publish([{message: "success"}]);      
      var successFunc = function() {
        $.Topic(pubSub.topicNames.USER_LOGOUT_SUCCESSFUL).publish([{message: "success"}]);
        self.clearUserData();
        self.profileRedirect();
        if(self.refreshPageAfterContactLogout()){
          self.refreshPageAfterContactLogout(false);
          self.navigateToPage(self.contextData.global.links.home.route);
        }
      };
      var errorFunc = function(pResult) {
        self.clearUserData();
        self.profileRedirect();
      };
      if (self.loggedIn()) {
        if(self.parentOrganization &amp;&amp; self.parentOrganization.name()){
          self.refreshPageAfterContactLogout(true);
        }
        self.client().logout(successFunc, errorFunc);
      } else {
        self.clearUserData();
        $.Topic(pubSub.topicNames.USER_LOGOUT_SUCCESSFUL).publish([{message: "success"}]);
        self.profileRedirect();
      }
      
    };
      
    /**
     * Profile Redirect.
     * 
     * @private
     * @function
     * @name UserViewModel#profileRedirect
     */
    UserViewModel.prototype.profileRedirect = function() {
      var self = this;
      
      if (navigation.isPathEqualTo(self.contextData.global.links.profile.route) ||
          navigation.isPathEqualTo(self.contextData.global.links.orderHistory.route) ||
          navigation.isPathEqualTo(self.contextData.global.links.orderDetails.route)) {
        
        navigation.goTo(self.contextData.global.links.home.route);
      }
    };
    
    /**
     * Clear user data after session expiry or logout, if the user does not opt to re-login.
     * 
     * @private
     * @function
     * @name UserViewModel#clearUserData
     */
    UserViewModel.prototype.clearUserData = function() {
      var self = this;
      self.isUserSessionExpired(false);
      self.isUserLoggedOut(true);
      self.removeLocalData();
      self.loggedIn(false);
      self.editShippingAddress(null);
      self.deleteShippingAddress(false);
      self.shippingAddressBook([]);
      self.resetLoginData();
      self.reset();
      self.updatedShippingAddress = null;
      self.updatedShippingAddressBook = null;
      self.id(null);
      self.parentOrganization = new ParentOrganisation();
      $.Topic(pubSub.topicNames.USER_LOAD_SHIPPING).publish([{message: "success"}]);
    };
    
    /**
     * Handle cancelling a login in progress. Invoked on receiving a .USER_LOGIN_CANCEL pubsub event.
     * 
     * @private
     * @function
     * @name UserViewModel#handleCancel
     */
    UserViewModel.prototype.handleCancel = function() {
      var self = this;
      self.resetLoginData();
      notifier.clearError(self.WIDGET_ID);
    };
    
    /**
     * Handle new user registration. Invoked on receiving a USER_REGISTRATION_SUBMIT pubsub event.
     * 
     * @private
     * @function
     * @name UserViewModel#registerUser
     * @param {Object} obj Widget
     */
    UserViewModel.prototype.registerUser = function(obj) {
      var self = this;
      self.receiveEmail = self.emailMarketingMails() ? "yes" : "no";
      var inputParams = {};
      inputParams[CCConstants.PROFILE_EMAIL] = self.emailAddress();
      inputParams[CCConstants.PROFILE_PASSWORD] = self.newPassword();
      inputParams[CCConstants.PROFILE_FIRST_NAME] = self.firstName();
      inputParams[CCConstants.PROFILE_LAST_NAME] = self.lastName();
      inputParams[CCConstants.PROFILE_RECEIVE_EMAIL] = self.receiveEmail;
      
      // Adding shipping addresses if they exist
      if (self.shippingAddressBook() !== null &amp;&amp; self.shippingAddressBook() != undefined &amp;&amp; self.isShippingAddressBookValid()) {
        inputParams[CCConstants.PROFILE_SHIPPING_ADDRESSES] = self.shippingAddressBook();
      }
      
      if (!self.locale()) {
        var currentLocale = ccRestClient.getStoredValue(CCConstants.LOCAL_STORAGE_USER_CONTENT_LOCALE);
        if (currentLocale) {
         self.locale(JSON.parse(currentLocale)[0].name);
        }
      }
      inputParams[CCConstants.PROFILE_LOCALE] = self.locale();
      
      self.adapter.persistCreate(CCConstants.ENDPOINT_CREATE_PROFILE, CCConstants.ENDPOINT_CREATE_PROFILE, inputParams,
        //success callback 
        function(data) {
          data.widgetId = obj.widgetId;
          self.handleAutoLogin(obj);
        },
        function(data) {
          data.widgetId = obj.widgetId;
          if (data.errorCode == CCConstants.CREATE_PROFILE_USER_EXISTS){
            data.message = CCi18n.t('ns.common:resources.accountAlreadyExists');	  
          }
          
          $.Topic(pubSub.topicNames.USER_CREATION_FAILURE).publish(data);
        }
      );
    };
    
    /**
     * Handle the auto-login of a user from the front end.
     * This is used to auto-login users after they are registered.
     * 
     * THIS SHOULD ONLY BE USED TO AUTO-LOGIN as it does not have
     * a lot of checks needed for normal login. Invoked on registering
     * a user successfully.
     * 
     * @private
     * @function
     * @name UserViewModel#handleAutoLogin
     */
    UserViewModel.prototype.handleAutoLogin = function(obj) {
      var self = this;
      self.orderId('');
      self.login(self.emailAddress());
      self.client().login(self.login(), self.newPassword(),
        // Success Function
        function() {
          var data ={};
          data.widgetId = obj.widgetId;
          self.loginSuccessFunc(true);
          $.Topic(pubSub.topicNames.USER_AUTO_LOGIN_SUCCESSFUL).publish(data);
        },
        // Error function
        function(pResult) {
          pResult.widgetId = obj.widgetId;
          self.loginErrorFunc();
          $.Topic(pubSub.topicNames.USER_AUTO_LOGIN_FAILURE).publish(pResult);
        }
      );
    };  
    
    /**
     * Get current user profile
     * Gets the logged-in user's data via a REST call.
     * 
     * @function
     * @name UserViewModel#getCurrentUser
     * @param {boolean} isAutoLogin Flag to suppress some actions for auto-login.
     * @param {boolean} isLogin Flag to perform few actions after login.
     */
    UserViewModel.prototype.getCurrentUser = function(isAutoLogin, isLogin) {
      var self = this;
      self.adapter.loadJSON('getUser', 'getCurrentUser', null,
        //success callback 
        function(data) {
          // Currently ignoring the 'links' property as it is not being used and causing problems in ccLink custom binding
          ko.mapping.fromJS(data, {'ignore': ["links"]}, self);
          self.populateUserViewModel(data);
          self.resetModified();
          self.readyToDisplay(true);
          if (!isAutoLogin) {
            $.Topic(pubSub.topicNames.USER_LOAD_SHIPPING).publish([{message: "success"}]);
          } else {
            $.Topic(pubSub.topicNames.AUTO_LOGIN_AND_GET_USER_DATA_SUCCESSFUL).publish();
          }
          if(isLogin) {
            $.Topic(pubSub.topicNames.USER_LOAD_CART).publish(data);

            if(data.parentOrganization &amp;&amp; data.parentOrganization.name) {
              self.navigateToPage(self.contextData.global.links.home.route);
            }
          }
        },
        //error callback
        function(data) {
          if (data.status == CCConstants.HTTP_UNAUTHORIZED_ERROR) {
            self.handleSessionExpired();
            if (navigation.isPathEqualTo(self.contextData.global.links.profile.route) || navigation.isPathEqualTo(self.contextData.global.links.orderHistory.route)) {
              navigation.doLogin(navigation.getPath(), self.contextData.global.links.home.route);
            }
          }
        }
      ); 
    };
    
    /**
     * Populate the user view model.
     * 
     * @function
     * @name UserViewModel#populateUserViewModel
     * @param {Object} userData Object containing source user data.
     */
    UserViewModel.prototype.populateUserViewModel = function(userData) {
      var self = this;
      self.emailAddress(userData.email);
      self.firstName(userData.firstName);
      self.lastName(userData.lastName);
      self.loggedInUserName(userData.firstName);
      self.login(self.emailAddress());
      self.id(userData.id);
      self.locale("");

      if (userData.parentOrganization) {
        self.parentOrganization.name(userData.parentOrganization.name);
        self.parentOrganization.description(userData.parentOrganization.description);
        self.parentOrganization.organizationLogoURL(userData.parentOrganization.organizationLogoURL);
        self.parentOrganization.organizationLogoAltText(userData.parentOrganization.organizationLogoAltText);
        self.parentOrganization.organizationLogoTitle(userData.parentOrganization.organizationLogoTitle);
      }

      var recieveEmail = userData.receiveEmail;
      if (recieveEmail == "yes") {
        self.emailMarketingMails(true);
      } else {
        self.emailMarketingMails(false);
      }
      
      // Reset KO modified properties  
      self.deleteShippingAddress(false);    
      self.updatedShippingAddress = userData.shippingAddress; // This is the default shipping address the server sends back
      if (self.updatedShippingAddress) {
        self.updatedShippingAddress.isDefaultAddress = true;
      }
      
      self.updatedShippingAddressBook = userData.shippingAddresses;
      if (self.updatedShippingAddressBook.length) {
        if(self.updatedShippingAddress == null) {
             //Setting the entry in address book to default address when null is being returned
             self.updatedShippingAddressBook[0].isDefaultAddress = true;
        } else {
        for (var k = 0, kMax = self.updatedShippingAddressBook.length; k &lt; kMax; k++) {
          self.updatedShippingAddressBook[k].isDefaultAddress = 
              (self.updatedShippingAddressBook[k].repositoryId === self.updatedShippingAddress.repositoryId);
          }
        }
      }

      self.organizationAddressBook = [];
	  for(var addressIndex in userData.secondaryAddresses){
	    var shippingAddress = userData.secondaryAddresses[addressIndex];
		shippingAddress.isDefaultAddress=false;
	    self.organizationAddressBook.push(userData.secondaryAddresses[addressIndex]);
	  }
	  
	  self.contactShippingAddress = userData.contactShippingAddress;
	  self.contactBillingAddress = userData.contactBillingAddress;

      self.sortShippingAddresses();
      
      self.isUserSessionExpired(false);
      self.isUserLoggedOut(false);
      self.populateUserFromLocalData(false);
      self.setLocalData('all');
      
      //Assigning profile locale after checking if it is part of supported locales.
      //Update the user locale if it not supported.
      for (var i=0; i&lt;this.contextData.global.site.additionalLanguages.length; i++) {
          if (userData.locale === this.contextData.global.site.additionalLanguages[i].name) {
            self.locale(userData.locale);
            if (self.locale.isModified !== undefined) {
              self.locale.isModified(false);
            }
          }
        }
      if (!self.locale()) {
        self.updateLocaleToSupported();
      }

    };
    
    /**
     * Set the context data from the UserDataInitializer.
     * 
     * @function
     * @name UserViewModel#setContext
     * @param {Object} pContext Context Data
     */
    UserViewModel.prototype.setContext = function(pContext) {
      var self = this;
      self.contextData = pContext;
      self.myAccountHash = self.contextData.global.links.profile.route;
      self.checkoutHash = self.contextData.global.links.checkout.route;
      self.homeHash = self.contextData.global.links.home.route;
      self.passwordPolicies(pContext.global.passwordPolicies);
      self.readyToDisplay(true);
      if(pContext.global.user.catalog) {
        self.catalogId(pContext.global.user.catalog.repositoryId);
      }
      // Added this to be backward compatible.
      if(self.catalog) {
    	self.catalog = undefined;
      }
      if (pContext.global.user.firstName) {
        self.populateUserViewModel(pContext.global.user);
      } else {
        self.populateUserFromLocalData(true);
        if (!self.isUserLoggedOut() &amp;&amp; !self.loggedIn() &amp;&amp; !self.isUserSessionExpired() &amp;&amp; self.login() != undefined &amp;&amp; self.login() !='') {
          self.handleSessionExpired();
        }
      }
    };
    
    /**
     * Refreshes the data in the user view modal with the current user when the page changes. Invoked on
     * receiving a PAGE_LAYOUT_LOADED, or PAGE_METADATA_CHANGED pubsub event.
     * 
     * @private
     * @function
     * @name UserViewModel#handPageChanged
     */
    UserViewModel.prototype.handlePageChanged = function() {
      var self = this;
      if (!self.isPageRedirected() &amp;&amp; self.loggedIn() &amp;&amp; !self.loggedinAtCheckout()) {
        $.Topic(pubSub.topicNames.REFRESH_USER_CART).publish(self);
      }
      self.isPageRedirected(false);
    };

    /**
     * Handle session expiry- reset all data and reload login data from local storage. Invoked on
     * receiving a USER_SESSION_EXPIRED pubsub event.
     * 
     * @private
     * @function
     * @name UserViewModel#handleSessionExpired
     */
    UserViewModel.prototype.handleSessionExpired = function() {
      var self = this;
      if (!self.isUserSessionExpired() &amp;&amp; !self.isUserLoggedOut()) {
        self.loggedIn(false);
        if (!navigation.isPathEqualTo(self.myAccountHash) &amp;&amp; self.isSesExpDuringPlaceOrder() == false) {       
          self.resetLoginData();
          self.reset();
          self.id(null);
        }
        if (!navigation.isPathEqualTo(self.checkoutHash) &amp;&amp; !(navigation.getPath().indexOf(self.checkoutHash) >= 0)) {
          $.Topic(pubSub.topicNames.USER_CLEAR_CART).publish(self);
        }
        self.populateUserFromLocalData(true);
        self.orderId('');
        self.loggedinAtCheckout(false);
        self.loggedoutAtCheckout(false);
        self.isUserSessionExpired(true);
        self.isUserLoggedOut(false);
        self.setLocalData('sessionExpiry');
        self.client().clearRefreshInterval();
        self.readyToDisplay(true);
      }
    };
    
    /**
     * Handle session validation. Invoked on receiving a USER_SESSION_VALID pubsub event.
     * 
     * @private
     * @function
     * @name UserViewModel#handleSessionValid
     */
    UserViewModel.prototype.handleSessionValid = function() {
      var self = this;
      self.loggedIn(self.client().loggedIn);
      self.isUserSessionExpired(false);
      self.isUserLoggedOut(false);
      self.setLocalData('sessionExpiry');
      self.readyToDisplay(true);
    };
    
    /**
     * Check if user is allowed to navigate to privileged pages and redirect if not. Will do nothing
     * if user profile has unsaved changes.
     * 
     * @function
     * @name UserViewModel#validatePrivilagePageRequest
     * @param {Object} data The object bound to the event.
     * @param {Object} event The current event.
     * @returns {boolean} true if the user profile has unsaved changes, otherwise false
     */
   UserViewModel.prototype.validatePrivilagePageRequest = function(data, event) {
      var self = this;
      // returns if the profile has unsaved changes.
      if (self.isUserProfileEdited()) {
        return true;
      }
      var hash = event.currentTarget.pathname;
      var link = '';
      var index = hash.indexOf("#!");
      if (index >= 0) {
        hash = hash.substring(index + 2);
      }
      self.validateAndRedirectPage(hash);
      return false;
    };
    
    /**
     * Navigates to the page based on the given hash.If given hash and current path is same
     * then it refreshes the current layout with current page id else navigates to the page
     * based on the given hash.
     *
     * @function
     * @name UserViewModel#navigateToPage
     * @param {string} hash page to refresh or redirect to.
     */
    UserViewModel.prototype.navigateToPage = function(hash) {
      if(navigation.isPathEqualTo(hash)) {
        var eventData = {
          'pageId': navigation.getPath()
        };
        $.Topic(pubSub.topicNames.PAGE_VIEW_CHANGED).publish(eventData);
      } else {
        navigation.goTo(hash);
      }
    };

    /**
     * Check user privilege and redirect based on hash.
     * 
     * @private
     * @function
     * @name UserViewModel#validateAndRedirectPage
     * @param {string} hash Redirection hash code.
     * @returns {boolean} Always false.
     */
    UserViewModel.prototype.validateAndRedirectPage = function(hash) {
      var redirectLinkDetails, self = this;
      if (!(hash == CCConstants.PAYPAL_CHECKOUT_TYPE)) {
        redirectLinkDetails = [{message: "success", linkToRedirect: hash}];
      }
      if (!self.loggedIn() &amp;&amp; self.isUserSessionExpired()) {
        if (hash == CCConstants.PAYPAL_CHECKOUT_TYPE &amp;&amp; navigation.isPathEqualTo(self.checkoutHash)) {
          $.Topic(pubSub.topicNames.CONTINUE_TO_PAYPAL).publish();
        } else {
          navigation.doLogin(hash);
        }
      } else if (self.loggedIn()) {
        var successFunc = function() {
          self.handleSessionValid();
          if (self.pageToRedirect() &amp;&amp; self.pageToRedirect()!= '' &amp;&amp; self.pageToRedirect() == hash) {
            self.pageToRedirect(null);
          }
          if (hash == CCConstants.PAYPAL_CHECKOUT_TYPE) {
            $.Topic(pubSub.topicNames.CONTINUE_TO_PAYPAL).publish();
          } else {
            navigation.goTo(hash);
          }
        };
        var errorFunc = function(pResult) {
          if (pResult) {
            self.handleSessionExpired();
            navigation.doLogin(hash);
          }
        };
        self.client().refresh(successFunc, errorFunc);
      } else {
        navigation.goTo(hash);
      }
      return false;
    };
    
    /**
     * Update the user profile details. Invoked on receiving a USER_PROFILE_UPDATE_SUBMIT pubsub event.
     * 
     * @function
     * @name UserViewModel#updateUserProfile
     */
    UserViewModel.prototype.handleUpdateProfile = function() {
      var self = this;
      
      var isDataInValid = false;
      var isDataModified = false;
      var includeShippingAddress = false;
      var includeUserProfile = false;
      var includeUserPassword = false;
      
      // If we're updating because of a change to a shipping address...
      if(self.editShippingAddress() != null)
      {
        // Check if it's a new shipping address and add it to the address book.
        if ($.inArray(self.editShippingAddress(), self.shippingAddressBook()) &lt; 0) {
          self.shippingAddressBook.push(self.editShippingAddress());
        }
        
        // If this was the first shipping address added, make it automatically the default.
        if (self.shippingAddressBook().length === 1) {
          self.shippingAddressBook()[0].isDefaultAddress(true);
        }

        if (self.editShippingAddress().isDefaultAddress()) {
          self.selectDefaultAddress(self.editShippingAddress());
        }
      }
      
      // checking whether shipping address is modified/valid.
      if (self.isShippingAddressBookModified()) {
        for (var k = 0; k &lt; self.shippingAddressBook().length; k++) {
          if (!self.shippingAddressBook()[k].validateNow()) {
            isDataInValid = true;
            break;
          }
        }
        includeShippingAddress = !isDataInValid; // Because addresses are validated first!
        isDataModified = true;
      }
      
      // checking whether user profile is modified/valid.
      if (self.isProfileModified()) {
        if (!self.isProfileValid()) {
          isDataInValid = true;
        } else {
          includeUserProfile = true;
        }
        isDataModified = true;
      }
      
      // checking whether user profile is modified/valid.
      if (self.isPasswordModified()) {
        if (!self.isPasswordValid()) {
          isDataInValid = true;
        } else {
          includeUserPassword = true;
        }
        isDataModified = true;
      }
      
      if (!isDataModified) {
        // If data is not modified, show the view profile page.
        $.Topic(pubSub.topicNames.USER_PROFILE_UPDATE_NOCHANGE).publish();
        return;
      } else if (isDataInValid) {
        // If data is invalid, show error message.
        $.Topic(pubSub.topicNames.USER_PROFILE_UPDATE_INVALID).publish();
        return;
      }
      
      // Safe to get rid of our temp editing address

      self.receiveEmail = self.emailMarketingMails() ? "yes" : "no";
      
      var inputParams = {};
      
      inputParams[CCConstants.PROFILE_EMAIL] = self.emailAddress();
      inputParams[CCConstants.PROFILE_FIRST_NAME] = self.firstName();
      inputParams[CCConstants.PROFILE_LAST_NAME] = self.lastName();
      inputParams[CCConstants.PROFILE_RECEIVE_EMAIL] = self.receiveEmail;
      inputParams[CCConstants.PROFILE_LOCALE] = self.locale();
      
      if (includeShippingAddress) {
        inputParams[CCConstants.PROFILE_SHIPPING_ADDRESSES] = self.shippingAddressBook();
      }
      
      //update password changes
      if (includeUserPassword) {
        inputParams[CCConstants.PROFILE_OLD_PASSWORD] = self.oldPassword();
        inputParams[CCConstants.PROFILE_NEW_PASSWORD] = self.newPassword();
        inputParams[CCConstants.PROFILE_CONFIRM_PASSWORD] = self.confirmPassword();
      }      
      
      self.adapter.loadJSON(CCConstants.ENDPOINT_UPDATE_PROFILE, self.id(), inputParams,
        //success callback 
        function(data) {
          self.editShippingAddress(null);
          $.Topic(pubSub.topicNames.USER_PROFILE_UPDATE_SUCCESSFUL).publish(data);
        },
        //error callback
        function(data) {
          $.Topic(pubSub.topicNames.USER_PROFILE_UPDATE_FAILURE).publish(data);
        }
      );
      
      //reset the password
      self.resetPassword();
    };
    
    /**
     * Change the Profile Password.
     * 
     * @function
     * @name UserViewModel#updateExpiredPassword
     */
    UserViewModel.prototype.updateExpiredPassword = function() {
      var self = this;
      var inputParams = {};
      inputParams[CCConstants.PROFILE_LOGIN] = self.login();
      inputParams[CCConstants.PROFILE_OLD_PASSWORD] = self.oldPassword();
      inputParams[CCConstants.PROFILE_NEW_PASSWORD] = self.newPassword();
      inputParams[CCConstants.PROFILE_CONFIRM_PASSWORD] = self.confirmPassword();
      self.adapter.persistCreate(CCConstants.ENDPOINT_UPDATE_EXPIRED_PASSWORD, 'id', inputParams,
        //success callback 
        function(data) {
          $.Topic(pubSub.topicNames.USER_PROFILE_PASSWORD_UPDATE_SUCCESSFUL).publish(data);
          var currentPassword = self.newPassword();
          self.resetPassword();
          self.password(currentPassword);
        },
        //error callback
        function(data) {
          self.resetPassword();
          $.Topic(pubSub.topicNames.USER_PROFILE_PASSWORD_UPDATE_FAILURE).publish(data);
        }
      );
    };
    
    /**
     * Return the singleton global instance of UserViewModel. Creates it if it doesn't already exist.
     * 
     * @function
     * @name UserViewModel.getInstance
     * @param {RestAdapter} pAdapter REST Adapter.
     * @param {Object} pUserData Aditional user data.
     * @param {Object} pParams Some additional params (server data).
     * @returns {UserViewModel} The user view model.
     */
    UserViewModel.getInstance = function(pAdapter, pUserData, pParams) {
      if (!UserViewModel.singleInstance) {
        UserViewModel.singleInstance = new UserViewModel(pAdapter, pUserData);
      } else {
        if (!UserViewModel.singleInstance.loggedInUserName() &amp;&amp; pParams.global.user.firstName) {
          UserViewModel.singleInstance.loggedInUserName(pParams.global.user.firstName);
        }
      }
      
      // To always populate the view model with latest data from server.
      if (pParams) {
        UserViewModel.singleInstance.setContext(pParams);
      }
      
      return UserViewModel.singleInstance;
    };
    
    return UserViewModel;
  }
  
);
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-ccKoErrorWrapper.html">ccKoErrorWrapper</a></li><li><a href="module-ccKoExtensions.html">ccKoExtensions</a></li></ul><h3>Classes</h3><ul><li><a href="Address.html">Address</a></li><li><a href="CartViewModel.html">CartViewModel</a></li><li><a href="DynamicProperty.html">DynamicProperty</a></li><li><a href="EventDispatcher.html">EventDispatcher</a></li><li><a href="GiftCardViewModel.html">GiftCardViewModel</a></li><li><a href="GiftProductListingViewModel.html">GiftProductListingViewModel</a></li><li><a href="ko.bindingHandlers.background.html">background</a></li><li><a href="ko.bindingHandlers.carouselSwipe.html">carouselSwipe</a></li><li><a href="ko.bindingHandlers.ccForm.html">ccForm</a></li><li><a href="ko.bindingHandlers.ccLink.html">ccLink</a></li><li><a href="ko.bindingHandlers.ccValidation.html">ccValidation</a></li><li><a href="ko.bindingHandlers.checkbox.html">checkbox</a></li><li><a href="ko.bindingHandlers.chosen.html">chosen</a></li><li><a href="ko.bindingHandlers.contextResourcesNamespace.html">contextResourcesNamespace</a></li><li><a href="ko.bindingHandlers.currency.html">currency</a></li><li><a href="ko.bindingHandlers.datepicker.html">datepicker</a></li><li><a href="ko.bindingHandlers.datepopover.html">datepopover</a></li><li><a href="ko.bindingHandlers.draggable.html">draggable</a></li><li><a href="ko.bindingHandlers.droppable.html">droppable</a></li><li><a href="ko.bindingHandlers.fade.html">fade</a></li><li><a href="ko.bindingHandlers.hover.html">hover</a></li><li><a href="ko.bindingHandlers.imageSource.html">imageSource</a></li><li><a href="ko.bindingHandlers.imageZoom.html">imageZoom</a></li><li><a href="ko.bindingHandlers.localeText.html">localeText</a></li><li><a href="ko.bindingHandlers.makeAccess.html">makeAccess</a></li><li><a href="ko.bindingHandlers.modal.html">modal</a></li><li><a href="ko.bindingHandlers.modalTabbingContraint.html">modalTabbingContraint</a></li><li><a href="ko.bindingHandlers.onRender.html">onRender</a></li><li><a href="ko.bindingHandlers.popeditor.html">popeditor</a></li><li><a href="ko.bindingHandlers.popover.html">popover</a></li><li><a href="ko.bindingHandlers.productImageSource.html">productImageSource</a></li><li><a href="ko.bindingHandlers.propertyEditor.html">propertyEditor</a></li><li><a href="ko.bindingHandlers.radio.html">radio</a></li><li><a href="ko.bindingHandlers.richTextEditor.html">richTextEditor</a></li><li><a href="ko.bindingHandlers.scrollAffix.html">scrollAffix</a></li><li><a href="ko.bindingHandlers.select2.html">select2</a></li><li><a href="ko.bindingHandlers.select2Tags.html">select2Tags</a></li><li><a href="ko.bindingHandlers.selectable.html">selectable</a></li><li><a href="ko.bindingHandlers.slickList.html">slickList</a></li><li><a href="ko.bindingHandlers.slide.html">slide</a></li><li><a href="ko.bindingHandlers.slider.html">slider</a></li><li><a href="ko.bindingHandlers.spectrum.html">spectrum</a></li><li><a href="ko.bindingHandlers.tagsInput.html">tagsInput</a></li><li><a href="ko.bindingHandlers.textCheck.html">textCheck</a></li><li><a href="ko.bindingHandlers.timepicker.html">timepicker</a></li><li><a href="ko.bindingHandlers.triggerMessage.html">triggerMessage</a></li><li><a href="ko.bindingHandlers.validatableTarget.html">validatableTarget</a></li><li><a href="ko.bindingHandlers.validatableValue.html">validatableValue</a></li><li><a href="ko.bindingHandlers.widgetLocaleText.html">widgetLocaleText</a></li><li><a href="koValidation.alphaNumeric.html">alphaNumeric</a></li><li><a href="koValidation.alphaNumericNoSpaces.html">alphaNumericNoSpaces</a></li><li><a href="koValidation.alphaNumericNoSpacesWithSeperators.html">alphaNumericNoSpacesWithSeperators</a></li><li><a href="koValidation.alphaNumericWithSeperators.html">alphaNumericWithSeperators</a></li><li><a href="koValidation.bool.html">bool</a></li><li><a href="koValidation.creditcard.html">creditcard</a></li><li><a href="koValidation.cvv.html">cvv</a></li><li><a href="koValidation.endmonth.html">endmonth</a></li><li><a href="koValidation.endyear.html">endyear</a></li><li><a href="koValidation.importFileName.html">importFileName</a></li><li><a href="koValidation.laterDate.html">laterDate</a></li><li><a href="koValidation.match.html">match</a></li><li><a href="koValidation.mediaZipFileName.html">mediaZipFileName</a></li><li><a href="koValidation.number.html">number</a></li><li><a href="koValidation.observablePattern.html">observablePattern</a></li><li><a href="koValidation.password.html">password</a></li><li><a href="koValidation.price.html">price</a></li><li><a href="koValidation.propertyIdAlreadyInUse.html">propertyIdAlreadyInUse</a></li><li><a href="koValidation.propertyNameAlreadyInUse.html">propertyNameAlreadyInUse</a></li><li><a href="koValidation.restrictSlashCharacters.html">restrictSlashCharacters</a></li><li><a href="koValidation.startmonth.html">startmonth</a></li><li><a href="koValidation.startyear.html">startyear</a></li><li><a href="koValidation.uniqueTrimmed.html">uniqueTrimmed</a></li><li><a href="koValidation.uniqueTrimmedCaseInsensitive.html">uniqueTrimmedCaseInsensitive</a></li><li><a href="koValidation.url.html">url</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.addTemplate.html">addTemplate</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.ccDate.html">ccDate</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.ccDateTime.html">ccDateTime</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.ccNumber.html">ccNumber</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.disabled.html">disabled</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.element.html">element</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.embeddedAssistance.html">embeddedAssistance</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.inTabFlow.html">inTabFlow</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.setContextVariable.html">setContextVariable</a></li><li><a href="NavStateViewModel.html">NavStateViewModel</a></li><li><a href="OrderHistoryViewModel.html">OrderHistoryViewModel</a></li><li><a href="OrderViewModel.html">OrderViewModel</a></li><li><a href="ParentOrganisation.html">ParentOrganisation</a></li><li><a href="ProductListingSearchViewModel.html">ProductListingSearchViewModel</a></li><li><a href="ProductListingViewModel.html">ProductListingViewModel</a></li><li><a href="ProductViewModel.html">ProductViewModel</a></li><li><a href="PubSub.topicNames.html">topicNames</a></li><li><a href="resetCVV.html">resetCVV</a></li><li><a href="resetPaymentDetails.html">resetPaymentDetails</a></li><li><a href="SearchRestClient.html">SearchRestClient</a></li><li><a href="UserViewModel.html">UserViewModel</a></li><li><a href="WidgetViewModel.html">WidgetViewModel</a></li><li><a href="WishlistContentViewModel.html">WishlistContentViewModel</a></li></ul><h3>Namespaces</h3><ul><li><a href="ko.bindingHandlers.html">bindingHandlers</a></li><li><a href="ko.extenders.html">extenders</a></li><li><a href="koValidation.html">koValidation</a></li></ul><h3>Global</h3><ul><li><a href="global.html#CCEETagProcessor">CCEETagProcessor</a></li><li><a href="global.html#isValidDeterminewhetherornotthepaymentdetailsobjectisvalidbasedonthevalidityofitscomponentparts.Thiswillnotcauseerrormessagestobedisplayedforanyobservablevaluesthatareunchangedandhaveneverreceivedfocusontherelatedformfield(s).">isValid
Determine whether or not the payment details object is valid
based on the validity of its component parts. This will not
cause error messages to be displayed for any observable values
that are unchanged and have never received focus on the 
related form field(s).</a></li><li><a href="global.html#validatePaymentDetailsForceallrelevantmemberobservablestoperformtheirvalidationnow&displaytheerrors(ifany)">validatePaymentDetails
Force all relevant member observables to perform their
validation now & display the errors (if any)</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0</a> on Mon Oct 10 2016 10:49:02 GMT+0100 (BST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
